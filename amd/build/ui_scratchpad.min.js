/**
 * Implementation of the html_ui user interface plugin. For overall details
 * of the UI plugin architecture, see userinterfacewrapper.js.
 *
 * This plugin replaces the usual textarea answer element with a div
 * containing the author-supplied HTML. The serialisation of that HTML,
 * which is what is essentially copied back into the textarea for submissions
 * as the answer, is a JSON object. The fields of that object are the names
 * of all author-supplied HTML elements with a class 'coderunner-ui-element';
 * all such objects are expected to have a 'name' attribute as well. The
 * associated field values are lists. Each list contains all the values, in
 * document order, of the results of calling the jquery val() method in turn
 * on each of the UI elements with that name.
 * This means that at least input, select and textarea
 * elements are supported. The author is responsible for checking the
 * compatibility of other elements with jquery's val() method.
 *
 * The HTML to use in the answer area must be provided as the contents of
 * either the globalextra field or the prototypeextra field in the question
 * authoring form. The choice of which is set by the html_src UI parameter, which
 * must be either 'globalextra' or 'prototypeextra'.
 *
 * If any fields of the answer html are to be preloaded, these should be specified
 * in the answer preload with json of the form '{"<fieldName>": "<fieldValueList>",...}'
 * where fieldValueList is a list of all the values to be assigned to the fields
 * with the given name, in document order.
 *
 * To accommodate the possibility of dynamic HTML, any leftover preload values,
 * that is, values that cannot be positioned within the HTML either because
 * there is no field of the required name or because, in the case of a list,
 * there are insufficient elements, are assigned to the data['leftovers']
 * attribute of the outer html div, as a sub-object of the original object.
 * This outer div can be located as the 'closest' (in a jQuery sense)
 * div.qtype-coderunner-html-outer-div. The author-supplied HTML must include
 * JavaScript to make use of the 'leftovers'.
 *
 * As a special case of the serialisation, if all values in the serialisation
 * are either empty strings or a list of empty strings, the serialisation is
 * itself the empty string.
 *
 * @module coderunner/ui_html
 * @copyright  Richard Lobb, 2022, The University of Canterbury
 * @copyright  James Napier, 2022, The University of Canterbury
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_coderunner/ui_scratchpad",["jquery"],(function($){function escapeHtml(text){const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,(function(m){return map[m]}))}function combinedOutput(response,maxLen){const limit=s=>s.length<=maxLen?s:s.substr(0,maxLen)+"... (truncated)";return response.cmpinfo+limit(response.output)+limit(response.stderr)}function htmlTextArea(id,name,value){return"<textarea\n                    id='".concat(id,"'\n                    class='coderunner-ui-element' \n                    name='").concat(name,"' \n                    style='width: 100%'\n                   >").concat(value,"</textarea>")}function newAceUiWrapper(textAreaId){let ace;return require(["qtype_coderunner/userinterfacewrapper"],(function(uiWrapper){ace=uiWrapper.newUiWrapper("ace",textAreaId)})),ace}function DualBlobUi(textAreaId,width,height,uiParams){this.textArea=$(document.getElementById(textAreaId)),this.textAreaId=textAreaId,this.height=height,this.readOnly=this.textArea.prop("readonly"),this.uiParams=uiParams,this.fail=!1,this.spName=uiParams.sp_name||"Scratchpad",this.spButtonName=uiParams.sp_button_name||"Run!",this.spPrefixName=uiParams.sp_prefix_name||"Prefix Answer?",this.spRunLang=uiParams.sp_run_lang||this.uiParams.lang,this.spHtmlOutput=uiParams.sp_html_out||!1,this.spRunWrapper=uiParams.sp_run_wrapper||null,this.spRunWrapper&&"globalextra"===this.spRunWrapper&&(this.spRunWrapper=this.textArea.attr("data-globalextra")),this.blobDiv=null,this.scratchpadDiv=null,this.reload()}return DualBlobUi.prototype.failed=function(){return this.fail},DualBlobUi.prototype.failMessage=function(){return"DualBlobUiloadfail"},DualBlobUi.prototype.sync=function(){const prefixAns=$(document.getElementById(this.textAreaId+"-prefix-ans"));let serialisation={answer_code:this.answerTextArea.val()||"",test_code:this.spCodeTextArea.val()||"",show_hide:"",prefix_ans:""};this.scratchpadDiv.is(":visible")&&(serialisation.show_hide="1"),prefixAns.is(":checked")&&(serialisation.prefix_ans="1"),Object.values(serialisation).some((val=>1==val))?this.textArea.val(JSON.stringify(serialisation)):this.textArea.val("")},DualBlobUi.prototype.getElement=function(){return this.blobDiv},DualBlobUi.prototype.handleRunButtonClick=async function(ajax,outputDisplayArea){this.sync();const htmlOutput=this.spHtmlOutput,maxLen=this.uiParams["max-output-length"]||3e4,preloadString=this.textArea.val(),serial=JSON.parse(preloadString),params=this.uiParams.params;let code;var answerCode,testCode,prefixAns,template;outputDisplayArea.html(""),htmlOutput&&outputDisplayArea.hide(),outputDisplayArea.next("div.filter-ace-inline-html").remove(),this.spRunWrapper?(answerCode=serial.answer_code,testCode=serial.test_code,prefixAns=serial.prefix_ans,template=this.spRunWrapper,prefixAns||(answerCode=""),code=(template=template.replaceAll("{{ ANSWER_CODE }}",answerCode)).replaceAll("{{ SCRATCHPAD_CODE }}",testCode)):code=function(answerCode,testCode,prefixAns){let combined=prefixAns?answerCode+"\n":"";return combined+=testCode,combined}(serial.answer_code,serial.test_code,serial.prefix_ans),ajax.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{contextid:M.cfg.contextid,sourcecode:code,language:this.spRunLang,params:JSON.stringify(params)},done:function(responseJson){const response=JSON.parse(responseJson),error=function(response){const ERROR_RESPONSES=[[1,0,"error_access_denied"],[2,0,"error_unknown_language"],[3,0,"error_access_denied"],[4,0,"error_submission_limit_reached"],[5,0,"error_sandbox_server_overload"],[0,11,""],[0,12,""],[0,13,"error_timeout"],[0,15,""],[0,17,"error_memory_limit"],[0,21,"error_sandbox_server_overload"],[0,30,"error_excessive_output"]];for(const row of ERROR_RESPONSES)if(row[0]==response.error&&(0!=response.error||response.result==row[1]))return row[2];return"error_unknown_runtime"}(response);if(""===error)if(htmlOutput&&15===response.result){outputDisplayArea.next("div.filter-ace-inline-html").remove();const html=$("<div class='filter-ace-inline-html 'style='background-color:#eff;padding:5px;'>"+response.output+"</div>");outputDisplayArea.after(html)}else{const text=combinedOutput(response,maxLen);outputDisplayArea.show(),outputDisplayArea.html(escapeHtml(text))}else{let extra=0==response.error?combinedOutput(response,maxLen):"";"error_unknown_runtime"===error&&(extra+=response.error?"(Sandbox error code "+response.error+")":"(Run result: "+response.result+")"),langStringName=error,textarea=outputDisplayArea,additionalText=extra,require(["core/str"],(function(str){const promise=str.get_string(langStringName,"filter_ace_inline");$.when(promise).then((function(message){textarea.show(),textarea.html(escapeHtml("*** "+message+" ***\n"+additionalText))}))}))}var langStringName,textarea,additionalText},fail:function(error){alert(error.message)}}])},DualBlobUi.prototype.reload=function(){const preloadString=$(this.textArea).val(),answerTextAreaId=this.textAreaId+"-answer-code",spTextAreaId=this.textAreaId+"-sp-code";let preload={answer_code:"",test_code:"",show_hide:"",prefix_ans:""};try{preloadString&&(preload=JSON.parse(preloadString))}catch(error){return this.fail=!0,void(this.failString="blob_ui_invalidserialisation")}this.drawUi(answerTextAreaId,preload),this.drawScratchpadUi(spTextAreaId,preload),this.answerCodeUi=newAceUiWrapper(answerTextAreaId),this.spCodeUi=newAceUiWrapper(spTextAreaId),$(document.getElementById(this.textAreaId+"_wrapper")).css("resize","none")},DualBlobUi.prototype.drawUi=function(answerTextAreaId,preload){const t=this,divHtml="<div style='min-height:100%' class='qtype-coderunner-sp-outer-div'></div>",answerTextAreaHtml=htmlTextArea(answerTextAreaId,"answer_code",preload.answer_code),showButtonHtml="<a class='coderunner-ui-element' "+"name='show_hide'>▼".concat(this.spName,"</a>"),answerTextArea=$(answerTextAreaHtml),showButton=$(showButtonHtml);answerTextArea.attr("rows",this.textArea.attr("rows")),showButton.click((function(){const arrow=$(t.scratchpadDiv).is(":visible")?"▶":"▼";t.scratchpadDiv.toggle(),showButton.html(arrow+t.spName)})),this.blobDiv=$(divHtml),this.answerTextArea=answerTextArea,this.answerTextArea.attr("data-lang",this.uiParams.lang),this.blobDiv.append([answerTextArea,showButton]),this.scratchpadDiv=$(divHtml),preload.show_hide||(this.scratchpadDiv.hide(),showButton.html("▶".concat(this.spName)))},DualBlobUi.prototype.drawScratchpadUi=function(spTextAreaId,preload){const t=this,testCodeHtml=htmlTextArea(spTextAreaId,"test_code",preload.test_code),prefixAnsHtml=function(id,name,label,value,type){const checked=value&&value[0]?"checked":"",labelHtml="<label for='".concat(name,"'>").concat(label,"</label>");return"<input "+"id='".concat(id,"' ")+"type='".concat(type,"' ")+"".concat(checked," ")+"class='coderunner-ui-element' "+"name='".concat(name,"' ")+"value='".concat(value,"'>")+labelHtml}(this.textAreaId+"-prefix-ans","prefix_ans",this.spPrefixName,preload.prefix_ans,"checkbox"),runButton=$("<button type='button' class='btn btn-secondary' style='margin:6px;padding:2px 8px;'>"+"".concat(this.spButtonName,"</button>")),outputDisplayArea=$("<pre style='width:100%;white-space:pre-wrap;background-color:#eff;border:1px gray;padding:5px;overflow-wrap:break-word;max-height:600px;overflow:auto;'></pre>");outputDisplayArea.hide(),runButton.on("click",(function(){require(["core/ajax"],(function(ajax){t.handleRunButtonClick(ajax,outputDisplayArea,preload.test_code)}))})),this.spCodeTextArea=$(testCodeHtml),this.spCodeTextArea.attr("data-lang",this.uiParams.lang),this.spCodeTextArea.attr("rows","4"),this.scratchpadDiv.append([this.spCodeTextArea,runButton,$(prefixAnsHtml),outputDisplayArea]),this.blobDiv.append(this.scratchpadDiv)},DualBlobUi.prototype.resize=function(){},DualBlobUi.prototype.hasFocus=function(){let focused=!1;return this.blobDiv.find("textarea").each((function(){this===document.activeElement&&(focused=!0)})),focused},DualBlobUi.prototype.destroy=function(){this.sync(),$(this.blobDiv).remove(),this.blobDiv=null},{Constructor:DualBlobUi}}));

//# sourceMappingURL=ui_scratchpad.min.js.map